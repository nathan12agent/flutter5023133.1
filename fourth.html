import 'dart:async';
import 'dart:math';
import 'package:flutter/material.dart';

void main() {
  runApp(const AimTrainerApp());
}

class AimTrainerApp extends StatelessWidget {
  const AimTrainerApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: "Aim Trainer",
      debugShowCheckedModeBanner: false,
      home: const AimTrainerGame(),
    );
  }
}

class AimTrainerGame extends StatefulWidget {
  const AimTrainerGame({super.key});

  @override
  State<AimTrainerGame> createState() => _AimTrainerGameState();
}

class _AimTrainerGameState extends State<AimTrainerGame> {
  final Random _random = Random();
  Offset? targetPosition;
  int score = 0;
  int timeLeft = 30; // seconds
  int totalShots = 0;
  bool isPlaying = false;
  Timer? gameTimer;
  Timer? targetTimer;

  // Difficulty settings
  int targetDespawnMs = 1500; // milliseconds

  void startGame(String difficulty) {
    // Difficulty presets
    if (difficulty == "Easy") {
      targetDespawnMs = 1500;
    } else if (difficulty == "Medium") {
      targetDespawnMs = 1000;
    } else if (difficulty == "Hard") {
      targetDespawnMs = 600;
    }

    setState(() {
      score = 0;
      totalShots = 0;
      timeLeft = 30;
      isPlaying = true;
    });

    generateTarget();

    // Game countdown
    gameTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
      setState(() {
        timeLeft--;
        if (timeLeft <= 0) {
          stopGame();
        }
      });
    });
  }

  void generateTarget() {
    final size = MediaQuery.of(context).size;
    double x = _random.nextDouble() * (size.width - 80) + 40;
    double y = _random.nextDouble() * (size.height - 200) + 100;

    setState(() {
      targetPosition = Offset(x, y);
    });

    // Despawn after time
    targetTimer?.cancel();
    targetTimer = Timer(Duration(milliseconds: targetDespawnMs), () {
      totalShots++; // counts as missed
      generateTarget();
    });
  }

  void hitTarget() {
    setState(() {
      score++;
      totalShots++;
    });
    generateTarget();
  }

  void stopGame() {
    gameTimer?.cancel();
    targetTimer?.cancel();
    setState(() {
      isPlaying = false;
      targetPosition = null;
    });
  }

  double get accuracy {
    if (totalShots == 0) return 0;
    return (score / totalShots) * 100;
  }

  @override
  void dispose() {
    stopGame();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black87,
      appBar: AppBar(
        title: const Text("Aim Trainer"),
        backgroundColor: Colors.deepPurple,
      ),
      body: SafeArea(
        child: Stack(
          children: [
            // Score, Timer, Accuracy
            Positioned(
              top: 20,
              left: 20,
              child: Text(
                "Score: $score",
                style: const TextStyle(color: Colors.white, fontSize: 20),
              ),
            ),
            Positioned(
              top: 20,
              right: 20,
              child: Text(
                "Time: $timeLeft",
                style: const TextStyle(color: Colors.white, fontSize: 20),
              ),
            ),
            Positioned(
              top: 50,
              left: 20,
              child: Text(
                "Accuracy: ${accuracy.toStringAsFixed(1)}%",
                style: const TextStyle(color: Colors.white, fontSize: 18),
              ),
            ),

            // Target
            if (targetPosition != null)
              Positioned(
                left: targetPosition!.dx - 20,
                top: targetPosition!.dy - 20,
                child: GestureDetector(
                  onTap: hitTarget,
                  child: Container(
                    width: 40,
                    height: 40,
                    decoration: BoxDecoration(
                      color: Colors.red,
                      shape: BoxShape.circle,
                      border: Border.all(color: Colors.white, width: 2),
                    ),
                  ),
                ),
              ),

            // Start Screen
            if (!isPlaying)
              Center(
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Text(
                      "Final Score: $score",
                      style: const TextStyle(color: Colors.white, fontSize: 22),
                    ),
                    Text(
                      "Accuracy: ${accuracy.toStringAsFixed(1)}%",
                      style: const TextStyle(color: Colors.white, fontSize: 20),
                    ),
                    const SizedBox(height: 20),
                    ElevatedButton(
                      onPressed: () => startGame("Easy"),
                      child: const Text("Start Easy"),
                    ),
                    const SizedBox(height: 10),
                    ElevatedButton(
                      onPressed: () => startGame("Medium"),
                      child: const Text("Start Medium"),
                    ),
                    const SizedBox(height: 10),
                    ElevatedButton(
                      onPressed: () => startGame("Hard"),
                      child: const Text("Start Hard"),
                    ),
                  ],
                ),
              ),
          ],
        ),
      ),
    );
  }
}